import os
import sys
from datetime import datetime
from pathlib import Path

from flask import Flask, render_template, redirect, url_for, request, flash, jsonify, session
from flask_login import LoginManager, login_user, logout_user, login_required, current_user, UserMixin
from flask_sqlalchemy import SQLAlchemy
import requests
from dotenv import load_dotenv

# Importer le module API
from bot_api import get_bot_stats, get_moderation_actions, get_active_giveaways

load_dotenv()

app = Flask(__name__)
app.config['SECRET_KEY'] = os.urandom(24).hex()
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///dashboard.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)
login_manager = LoginManager(app)
login_manager.login_view = 'login'

# Modèles de base de données
class User(db.Model, UserMixin):
    id = db.Column(db.Integer, primary_key=True)
    discord_id = db.Column(db.String(80), unique=True, nullable=False)
    username = db.Column(db.String(80), nullable=False)
    avatar = db.Column(db.String(200))
    is_owner = db.Column(db.Boolean, default=False)
    last_login = db.Column(db.DateTime, default=datetime.utcnow)

@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

# Créer les tables de la base de données au démarrage
with app.app_context():
    db.create_all()
    print("✅ Base de données initialisée")

# Routes
@app.route('/')
def index():
    if current_user.is_authenticated:
        return redirect(url_for('dashboard'))
    return render_template('login.html')

@app.route('/login')
def discord_login():
    discord_oauth_url = (
        f"https://discord.com/api/oauth2/authorize"
        f"?client_id={os.getenv('DISCORD_CLIENT_ID')}"
        f"&redirect_uri={os.getenv('DISCORD_REDIRECT_URI')}"
        f"&response_type=code"
        f"&scope=identify"
    )
    return redirect(discord_oauth_url)

@app.route('/callback')
def discord_callback():
    code = request.args.get('code')
    
    data = {
        'client_id': os.getenv('DISCORD_CLIENT_ID'),
        'client_secret': os.getenv('DISCORD_CLIENT_SECRET'),
        'grant_type': 'authorization_code',
        'code': code,
        'redirect_uri': os.getenv('DISCORD_REDIRECT_URI'),
        'scope': 'identify'
    }
    
    headers = {'Content-Type': 'application/x-www-form-urlencoded'}
    response = requests.post('https://discord.com/api/oauth2/token', data=data, headers=headers)
    credentials = response.json()
    
    if 'access_token' not in credentials:
        flash("Erreur d'authentification Discord", 'danger')
        return redirect(url_for('index'))
    
    access_token = credentials['access_token']
    
    # Récupérer les informations utilisateur
    user_response = requests.get('https://discord.com/api/users/@me', headers={
        'Authorization': f'Bearer {access_token}'
    })
    user_data = user_response.json()
    
    avatar_url = f"https://cdn.discordapp.com/avatars/{user_data['id']}/{user_data['avatar']}.png"
    
    # Vérifier si c'est le propriétaire (votre ID)
    is_owner = (int(user_data['id']) == 1274391702655864883)
    
    user = User.query.filter_by(discord_id=user_data['id']).first()
    if not user:
        user = User(
            discord_id=user_data['id'],
            username=user_data['username'],
            avatar=avatar_url,
            is_owner=is_owner
        )
        db.session.add(user)
    else:
        user.username = user_data['username']
        user.avatar = avatar_url
        user.last_login = datetime.utcnow()
    
    db.session.commit()
    login_user(user)
    
    return redirect(url_for('dashboard'))

@app.route('/dashboard')
@login_required
def dashboard():
    # Récupérer les vraies données du bot via l'API
    stats = get_bot_stats()
    recent_actions = get_moderation_actions(5)
    active_giveaways = get_active_giveaways()
    
    # Données pour le graphique (à remplacer par de vraies données)
    chart_labels = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim']
    chart_data = [12, 19, 3, 5, 2, 3, 7]
    
    return render_template('dashboard.html', 
                         stats=stats,
                         recent_actions=recent_actions,
                         active_giveaways=active_giveaways,
                         chart_labels=chart_labels,
                         chart_data=chart_data)

@app.route('/servers')
@login_required
def servers():
    if not current_user.is_owner:
        flash("Accès réservé au propriétaire", 'danger')
        return redirect(url_for('dashboard'))
    
    # Récupérer la liste des serveurs depuis l'API
    # À implémenter
    servers = []
    return render_template('servers.html', servers=servers)

@app.route('/moderation')
@login_required
def moderation():
    if not current_user.is_owner:
        flash("Accès réservé au propriétaire", 'danger')
        return redirect(url_for('dashboard'))
    
    # Récupérer les actions de modération
    actions = get_moderation_actions(50)
    return render_template('moderation.html', actions=actions)

@app.route('/giveaways')
@login_required
def giveaways():
    if not current_user.is_owner:
        flash("Accès réservé au propriétaire", 'danger')
        return redirect(url_for('dashboard'))
    
    # Récupérer tous les giveaways (actifs et terminés)
    active = get_active_giveaways()
    # À ajouter : récupérer les giveaways terminés
    ended = []
    return render_template('giveaways.html', active=active, ended=ended)

@app.route('/logs')
@login_required
def logs():
    if not current_user.is_owner:
        flash("Accès réservé au propriétaire", 'danger')
        return redirect(url_for('dashboard'))
    
    # Récupérer les logs
    # À implémenter
    logs = []
    return render_template('logs.html', logs=logs)

@app.route('/logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('index'))

# ==================== API ROUTES ====================

@app.route('/api/bot/stats')
@login_required
def api_bot_stats():
    if not current_user.is_owner:
        return jsonify({'error': 'Unauthorized'}), 403
    
    return jsonify(get_bot_stats())

@app.route('/api/giveaway/<message_id>/end', methods=['POST'])
@login_required
def api_end_giveaway(message_id):
    if not current_user.is_owner:
        return jsonify({'error': 'Unauthorized'}), 403
    
    # Appeler l'API du bot pour terminer le giveaway
    try:
        response = requests.post(
            f"{os.getenv('BOT_API_URL')}/api/giveaway/{message_id}/end",
            headers={'X-API-Key': os.getenv('BOT_API_KEY')},
            timeout=5
        )
        if response.status_code == 200:
            return jsonify({'success': True})
    except:
        pass
    
    return jsonify({'error': 'Failed to end giveaway'}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.getenv('PORT', 5000)), debug=True)
